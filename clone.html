<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DIAGN√ìSTICO - Google Sheets</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .box {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover { background: #45a049; }
        .error { background: #ffebee; color: #c62828; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .success { background: #e8f5e9; color: #2e7d32; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .info { background: #e3f2fd; color: #1565c0; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .warning { background: #fff3e0; color: #e65100; padding: 15px; border-radius: 5px; margin: 10px 0; }
        pre {
            background: #263238;
            color: #aed581;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <h1>üîç DIAGN√ìSTICO COMPLETO - Google Sheets</h1>
    
    <div class="box">
        <h2>üìã Configuraci√≥n del Spreadsheet</h2>
        <label>ID del Spreadsheet:</label>
        <input type="text" id="sheetId" value="1pQrVe2O_NwgD0YdD_TcpVxwK1QNE1dw1kSjz-7kSTgU">
        
        <div class="warning">
            <strong>‚ö†Ô∏è IMPORTANTE:</strong> Para que esto funcione, tu Google Sheet debe estar configurado como:
            <ul>
                <li>‚úÖ Compartido con "Cualquiera con el enlace"</li>
                <li>‚úÖ Permisos: "Lector" o "Comentador" (no necesita ser Editor)</li>
                <li>‚úÖ En Archivo ‚Üí Compartir ‚Üí Cambiar a cualquiera que tenga el enlace</li>
            </ul>
        </div>
    </div>

    <div class="box">
        <h2>1Ô∏è‚É£ Test de Permisos</h2>
        <button onclick="testPermisos()">üîê Verificar Permisos</button>
        <div id="permisosResult"></div>
    </div>

    <div class="box">
        <h2>2Ô∏è‚É£ Test de URLs</h2>
        <button onclick="testURLs()">üåê Probar Diferentes URLs</button>
        <div id="urlsResult"></div>
    </div>

    <div class="box">
        <h2>3Ô∏è‚É£ Test de Lectura (M√©todo 1: gviz/tq)</h2>
        <button onclick="testMetodo1('Dias')">Leer Dias</button>
        <button onclick="testMetodo1('Capital')">Leer Capital</button>
        <button onclick="testMetodo1('Interes')">Leer Interes</button>
        <div id="metodo1Result"></div>
    </div>

    <div class="box">
        <h2>4Ô∏è‚É£ Test de Lectura (M√©todo 2: export?format=csv)</h2>
        <button onclick="testMetodo2('Dias')">Leer Dias (CSV)</button>
        <button onclick="testMetodo2('Capital')">Leer Capital (CSV)</button>
        <button onclick="testMetodo2('Interes')">Leer Interes (CSV)</button>
        <div id="metodo2Result"></div>
    </div>

    <div class="box">
        <h2>5Ô∏è‚É£ Informaci√≥n del Navegador</h2>
        <button onclick="mostrarInfoNavegador()">üì± Ver Info</button>
        <div id="browserInfo"></div>
    </div>

    <script>
        function getSheetId() {
            return document.getElementById('sheetId').value.trim();
        }

        async function testPermisos() {
            const div = document.getElementById('permisosResult');
            div.innerHTML = '<div class="info">‚è≥ Verificando permisos...</div>';
            
            try {
                const sheetId = getSheetId();
                const url = `https://docs.google.com/spreadsheets/d/${sheetId}/edit`;
                
                let html = '<div class="info">';
                html += '<strong>üîó URL de tu spreadsheet:</strong><br>';
                html += `<a href="${url}" target="_blank">${url}</a><br><br>`;
                html += '<strong>‚úÖ Para verificar permisos:</strong><br>';
                html += '1. Haz click en el enlace de arriba<br>';
                html += '2. Si se abre el spreadsheet ‚Üí Los permisos est√°n OK<br>';
                html += '3. Si pide login ‚Üí Necesitas compartirlo p√∫blicamente<br><br>';
                html += '<strong>üìã C√≥mo compartir:</strong><br>';
                html += '1. En Google Sheets, click en "Compartir" (arriba derecha)<br>';
                html += '2. Click en "Cambiar a cualquiera que tenga el enlace"<br>';
                html += '3. Aseg√∫rate que diga "Cualquiera con el enlace" puede "Ver"<br>';
                html += '</div>';
                
                div.innerHTML = html;
                
            } catch (error) {
                div.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }

        async function testURLs() {
            const div = document.getElementById('urlsResult');
            div.innerHTML = '<div class="info">‚è≥ Probando diferentes URLs...</div>';
            
            const sheetId = getSheetId();
            const urls = [
                {
                    nombre: 'gviz/tq (m√©todo actual)',
                    url: `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tq=SELECT%20A`
                },
                {
                    nombre: 'export CSV',
                    url: `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=0`
                },
                {
                    nombre: 'pub (publicado)',
                    url: `https://docs.google.com/spreadsheets/d/e/${sheetId}/pub?output=csv`
                }
            ];
            
            let html = '<h3>Resultados:</h3>';
            
            for (const test of urls) {
                try {
                    console.log(`Probando: ${test.nombre}`);
                    const response = await fetch(test.url);
                    const status = response.status;
                    const text = await response.text();
                    
                    if (status === 200) {
                        html += `<div class="success">‚úÖ ${test.nombre}: OK (${status})</div>`;
                        html += `<pre>${text.substring(0, 300)}...</pre>`;
                    } else {
                        html += `<div class="error">‚ùå ${test.nombre}: Error ${status}</div>`;
                        html += `<pre>${text.substring(0, 300)}</pre>`;
                    }
                } catch (error) {
                    html += `<div class="error">‚ùå ${test.nombre}: ${error.message}</div>`;
                }
            }
            
            div.innerHTML = html;
        }

        async function testMetodo1(nombreHoja) {
            const div = document.getElementById('metodo1Result');
            div.innerHTML = `<div class="info">‚è≥ Leyendo "${nombreHoja}" con m√©todo gviz/tq...</div>`;
            
            try {
                const sheetId = getSheetId();
                const query = encodeURIComponent(`SELECT A WHERE A IS NOT NULL`);
                const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?sheet=${nombreHoja}&tq=${query}`;
                
                console.log('URL:', url);
                
                const response = await fetch(url);
                console.log('Status:', response.status);
                console.log('Headers:', [...response.headers.entries()]);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const text = await response.text();
                console.log('Response (primeros 500 chars):', text.substring(0, 500));
                
                if (!text.includes('google.visualization.Query.setResponse')) {
                    throw new Error('Respuesta no es un gviz v√°lido. El sheet debe estar p√∫blico.');
                }
                
                const jsonString = text.substring(47).slice(0, -2);
                const data = JSON.parse(jsonString);
                
                if (data.status === 'error') {
                    const errorMsg = data.errors?.[0]?.detailed_message || data.errors?.[0]?.reason || 'Error desconocido';
                    throw new Error(`Google Sheets error: ${errorMsg}`);
                }
                
                const rows = data.table?.rows || [];
                
                let html = `<div class="success">‚úÖ "${nombreHoja}": ${rows.length} filas le√≠das</div>`;
                html += '<pre>';
                rows.forEach((row, idx) => {
                    const valor = row?.c?.[0]?.v;
                    const formato = row?.c?.[0]?.f;
                    html += `A${idx + 1}: ${formato || valor}\n`;
                });
                html += '</pre>';
                
                div.innerHTML = html;
                
            } catch (error) {
                console.error('Error completo:', error);
                let html = `<div class="error">‚ùå Error al leer "${nombreHoja}":<br><br>`;
                html += `<strong>Mensaje:</strong> ${error.message}<br><br>`;
                html += `<strong>Posibles causas:</strong><br>`;
                html += `‚Ä¢ El spreadsheet no est√° compartido p√∫blicamente<br>`;
                html += `‚Ä¢ La hoja "${nombreHoja}" no existe<br>`;
                html += `‚Ä¢ Hay un problema con CORS<br>`;
                html += `‚Ä¢ El navegador bloque√≥ la petici√≥n<br>`;
                html += '</div>';
                
                div.innerHTML = html;
            }
        }

        async function testMetodo2(nombreHoja) {
            const div = document.getElementById('metodo2Result');
            div.innerHTML = `<div class="info">‚è≥ Leyendo "${nombreHoja}" como CSV...</div>`;
            
            try {
                const sheetId = getSheetId();
                
                // Primero necesitamos obtener el gid de la hoja
                const hojaGids = {
                    'Dias': '0',
                    'Capital': '1',
                    'Interes': '2',
                    'Banner': '3'
                };
                
                const gid = hojaGids[nombreHoja] || '0';
                const url = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${gid}`;
                
                console.log('URL CSV:', url);
                
                const response = await fetch(url);
                console.log('Status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: No se pudo acceder. Verifica que el sheet est√© p√∫blico.`);
                }
                
                const text = await response.text();
                console.log('CSV recibido:', text.substring(0, 500));
                
                const lines = text.trim().split('\n');
                
                let html = `<div class="success">‚úÖ "${nombreHoja}": ${lines.length} l√≠neas le√≠das</div>`;
                html += '<pre>';
                lines.forEach((line, idx) => {
                    const valor = line.split(',')[0].replace(/"/g, '');
                    html += `A${idx + 1}: ${valor}\n`;
                });
                html += '</pre>';
                
                div.innerHTML = html;
                
            } catch (error) {
                console.error('Error CSV:', error);
                div.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }

        function mostrarInfoNavegador() {
            const div = document.getElementById('browserInfo');
            
            let html = '<div class="info">';
            html += '<strong>Informaci√≥n del Navegador:</strong><br><br>';
            html += `<strong>User Agent:</strong> ${navigator.userAgent}<br><br>`;
            html += `<strong>Online:</strong> ${navigator.onLine ? '‚úÖ S√≠' : '‚ùå No'}<br>`;
            html += `<strong>Idioma:</strong> ${navigator.language}<br>`;
            html += `<strong>Plataforma:</strong> ${navigator.platform}<br>`;
            html += `<strong>Cookies habilitadas:</strong> ${navigator.cookieEnabled ? '‚úÖ S√≠' : '‚ùå No'}<br>`;
            html += '</div>';
            
            div.innerHTML = html;
        }

        // Ejecutar al cargar
        console.log('üöÄ Diagn√≥stico iniciado');
        console.log('Sheet ID:', getSheetId());
    </script>
</body>
</html>
