<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>SimPrÃ©stamo</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@700;800&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#080b10; --surf:#0f1319; --card:#141a24; --card2:#19202e;
  --b1:#1c2535; --b2:#243047;
  --acc:#00e5b0; --acc2:#00b88d;
  --blue:#3b82f6; --gold:#f59e0b; --red:#ef4444;
  --txt:#dce8f5; --mut:#4d617d; --soft:#7a92b0;
  --r:14px; --rs:9px;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{font-size:16px;-webkit-tap-highlight-color:transparent}
body{
  font-family:'DM Sans',sans-serif;
  background:var(--bg);color:var(--txt);
  min-height:100dvh;overflow-x:hidden;
}
body::before{
  content:'';position:fixed;inset:0;z-index:0;pointer-events:none;
  background:
    radial-gradient(ellipse 60% 50% at 88% 4%,  rgba(0,229,176,.07) 0%,transparent 65%),
    radial-gradient(ellipse 50% 60% at 4%  96%, rgba(59,130,246,.05) 0%,transparent 65%);
}

.app{
  position:relative;z-index:1;
  max-width:430px;margin:0 auto;
  padding:0 16px 60px;
}

/* â”€â”€ HEADER â”€â”€ */
.hdr{
  display:flex;align-items:center;justify-content:space-between;
  padding:22px 0 6px;
}
.logo{
  font-family:'Syne',sans-serif;font-weight:800;
  font-size:1.28rem;letter-spacing:-.03em;
}
.logo em{color:var(--acc);font-style:normal}

.sdot{
  width:8px;height:8px;border-radius:50%;
  background:var(--mut);transition:background .4s;
}
.sdot.ok  {background:var(--acc)}
.sdot.off {background:var(--gold)}
.sdot.busy{background:var(--blue);animation:pulse .9s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}

/* sync strip */
.strip-wrap{height:2px;border-radius:99px;background:var(--b1);overflow:hidden;margin-bottom:6px}
.strip-fill{
  height:100%;width:0%;border-radius:99px;
  background:linear-gradient(90deg,var(--acc),var(--blue));
  transition:width .35s ease, opacity .4s;opacity:0;
}
.strip-fill.on{opacity:1}

/* â”€â”€ BANNER â”€â”€ */
.banner{
  display:none;align-items:center;gap:9px;
  margin:4px 0 10px;padding:10px 14px;border-radius:var(--rs);
  background:rgba(0,229,176,.07);border:1px solid rgba(0,229,176,.18);
  font-size:.83rem;color:var(--acc);
}
.banner.show{display:flex}

/* â”€â”€ SECTION LABEL â”€â”€ */
.slabel{
  font-family:'Syne',sans-serif;font-size:.64rem;font-weight:700;
  letter-spacing:.1em;text-transform:uppercase;color:var(--mut);
  margin:22px 0 10px;
}

/* â”€â”€ CARD â”€â”€ */
.card{background:var(--card);border:1px solid var(--b1);border-radius:var(--r);padding:20px}

/* â”€â”€ CHIPS â”€â”€ */
.clabel{
  font-size:.74rem;font-weight:500;color:var(--soft);
  display:flex;align-items:center;gap:6px;margin-bottom:10px;
}
.chips{display:flex;flex-wrap:wrap;gap:7px;margin-bottom:20px}
.chips.g{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}

.chip{
  padding:8px 16px;border-radius:99px;
  border:1.5px solid var(--b2);background:var(--surf);
  color:var(--soft);font-size:.82rem;font-weight:500;
  cursor:pointer;user-select:none;
  transition:border-color .13s,background .13s,color .13s,transform .1s;
}
.chips.g .chip{border-radius:var(--rs);text-align:center;padding:10px 4px}
.chip:hover{border-color:var(--acc);color:var(--txt)}
.chip:active{transform:scale(.96)}
.chip.on{
  border-color:var(--acc);background:rgba(0,229,176,.12);
  color:var(--acc);font-weight:600;
}

/* skeleton */
.sk{
  background:linear-gradient(90deg,var(--surf) 25%,var(--card2) 50%,var(--surf) 75%);
  background-size:200% 100%;animation:sh 1.2s infinite;
  border-radius:99px;height:36px;
}
.chips.g .sk{border-radius:var(--rs)}
@keyframes sh{0%{background-position:200% 0}100%{background-position:-200% 0}}

.divider{height:1px;background:var(--b1);margin:0 0 20px}

/* â”€â”€ RESULTADO EN TIEMPO REAL â”€â”€ */
/* Panel siempre visible debajo del selector de capital */
.result-panel{
  margin-top:20px;
  border-radius:var(--r);overflow:hidden;
  border:1px solid var(--b2);
  background:var(--card2);
  transition:border-color .3s, box-shadow .3s;
}
.result-panel.active{
  border-color:rgba(0,229,176,.25);
  box-shadow:0 0 36px rgba(0,229,176,.07),0 8px 28px rgba(0,0,0,.4);
}

/* Header del resultado */
.rh{
  padding:20px 20px 14px;text-align:center;
  background:linear-gradient(135deg,rgba(0,229,176,.08) 0%,rgba(59,130,246,.05) 100%);
  border-bottom:1px solid var(--b1);
  transition:background .3s;
}
.rh.active{background:linear-gradient(135deg,rgba(0,229,176,.11) 0%,rgba(59,130,246,.08) 100%)}
.rh .rl{font-size:.66rem;color:var(--mut);letter-spacing:.08em;text-transform:uppercase;margin-bottom:6px}
.rh .rb{
  font-family:'Syne',sans-serif;font-size:2.4rem;font-weight:800;
  letter-spacing:-.04em;line-height:1;
  color:var(--mut);transition:color .25s;
}
.rh .rb.active{color:var(--acc)}
.rh .rs{font-size:.76rem;color:var(--mut);margin-top:5px;min-height:1.2em;transition:color .25s}
.rh .rs.active{color:var(--soft)}

/* Grid mÃ©tricas */
.rg{display:grid;grid-template-columns:1fr 1fr}
.ri{padding:14px 16px;border-right:1px solid var(--b1);border-bottom:1px solid var(--b1);transition:all .2s}
.ri:nth-child(2n){border-right:none}
.ri:nth-last-child(-n+2){border-bottom:none}
.rik{font-size:.65rem;color:var(--mut);text-transform:uppercase;letter-spacing:.07em;margin-bottom:4px}
.riv{
  font-family:'Syne',sans-serif;font-size:1.08rem;font-weight:700;
  color:var(--b2);transition:color .25s;
}
.riv.show{color:var(--txt)}
.riv.show.ac{color:var(--acc)}
.riv.show.go{color:var(--gold)}

/* Placeholder state */
.rplaceholder{
  padding:22px;text-align:center;
  font-size:.8rem;color:var(--mut);line-height:1.7;
}

/* footer del resultado */
.rf{
  display:flex;align-items:center;justify-content:center;gap:6px;
  padding:8px;background:var(--surf);font-size:.66rem;color:var(--mut);
  min-height:30px;
}
.rfd{width:4px;height:4px;border-radius:50%;background:var(--acc);opacity:0;transition:opacity .3s}
.rfd.show{opacity:1}

/* empty */
.empty{padding:20px 0;text-align:center;font-size:.81rem;color:var(--mut);line-height:1.7}
.empty span{font-size:1.7rem;display:block;margin-bottom:7px;opacity:.35}

/* toast */
#toast{
  position:fixed;bottom:20px;left:50%;
  transform:translateX(-50%) translateY(52px);
  background:var(--card2);border:1px solid var(--b2);
  padding:9px 18px;border-radius:99px;font-size:.8rem;color:var(--txt);
  box-shadow:0 8px 24px rgba(0,0,0,.5);
  transition:transform .3s cubic-bezier(.34,1.56,.64,1);
  white-space:nowrap;z-index:200;pointer-events:none;
}
#toast.show{transform:translateX(-50%) translateY(0)}

@media(max-width:360px){
  .rh .rb{font-size:2rem}
  .chips.g{grid-template-columns:repeat(2,1fr)}
}
</style>
</head>
<body>
<div class="app">

  <header class="hdr">
    <div class="logo">Sim<em>PrÃ©stamo</em></div>
    <div class="sdot" id="sdot"></div>
  </header>

  <div class="strip-wrap"><div class="strip-fill" id="strip"></div></div>

  <div class="banner" id="banner"><span>ğŸ“¢</span><span id="bannerTxt"></span></div>

  <p class="slabel">Simulador de prÃ©stamo</p>

  <div class="card">

    <!-- PLAZO -->
    <div class="clabel">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2">
        <rect x="3" y="4" width="18" height="18" rx="2"/>
        <line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/>
        <line x1="3" y1="10" x2="21" y2="10"/>
      </svg>
      Plazo
    </div>
    <div class="chips" id="chipsDias">
      <div class="sk" style="width:76px"></div>
      <div class="sk" style="width:76px"></div>
      <div class="sk" style="width:76px"></div>
    </div>

    <div class="divider"></div>

    <!-- CAPITAL -->
    <div class="clabel">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2">
        <line x1="12" y1="1" x2="12" y2="23"/>
        <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
      </svg>
      Capital solicitado
    </div>
    <div class="chips g" id="chipsCapital">
      <div class="sk"></div><div class="sk"></div><div class="sk"></div>
      <div class="sk"></div><div class="sk"></div><div class="sk"></div>
    </div>

    <!-- RESULTADO EN TIEMPO REAL (siempre visible) -->
    <div class="result-panel" id="resultPanel">
      <div class="rh" id="rHead">
        <div class="rl">Total a pagar</div>
        <div class="rb" id="rTotal">â€”</div>
        <div class="rs" id="rSub">Selecciona plazo y capital</div>
      </div>
      <div class="rg">
        <div class="ri">
          <div class="rik">Capital</div>
          <div class="riv" id="rCapital">â€”</div>
        </div>
        <div class="ri">
          <div class="rik">Tasa</div>
          <div class="riv ac" id="rTasa">â€”</div>
        </div>
        <div class="ri">
          <div class="rik">InterÃ©s total</div>
          <div class="riv go" id="rInteres">â€”</div>
        </div>
        <div class="ri">
          <div class="rik">Pago diario</div>
          <div class="riv ac" id="rDiario">â€”</div>
        </div>
      </div>
      <div class="rf">
        <div class="rfd" id="rDot"></div>
        <span id="rFooter">Esperando selecciÃ³nâ€¦</span>
      </div>
    </div>

  </div>

</div>
<div id="toast"></div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONFIG
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const SHEET_ID  = '19Viesr9Lhy347A9L03J_RuxftUhBduaYsBY206IO6X8';
const CACHE_TTL = 12 * 60 * 60 * 1000;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ESTADO â€” persiste en sessionStorage
   (sobrevive F5 sin perder la selecciÃ³n)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let SEL = rdSS('sp_sel') || { dias:null, capital:null };
let CACHE = { dias:[], capital:[], interes:{}, banner:{activo:false,texto:''} };
let syncActivo = false;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SESSION STORAGE HELPERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function rdSS(k){ try{ return JSON.parse(sessionStorage.getItem(k)); }catch(e){ return null; } }
function wrSS(k,v){ try{ sessionStorage.setItem(k, JSON.stringify(v)); }catch(e){} }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOCALSTORAGE CACHE
   Mismas claves que el test original:
   simulador_dias / simulador_capital /
   simulador_interes / simulador_banner
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function saveToCache(key, data){
  localStorage.setItem('simulador_'+key, JSON.stringify({ data, timestamp:Date.now() }));
}
function getFromCache(key){
  try{
    const raw = localStorage.getItem('simulador_'+key);
    if(!raw) return null;
    const p = JSON.parse(raw);
    return p?.data !== undefined ? p.data : p;
  }catch(e){ return null; }
}
function getCacheTs(key){
  try{ return JSON.parse(localStorage.getItem('simulador_'+key))?.timestamp||null; }catch(e){ return null; }
}
function cacheOk(){
  const d=getFromCache('dias'), c=getFromCache('capital'), i=getFromCache('interes');
  return Array.isArray(d)&&d.length>0 && Array.isArray(c)&&c.length>0 && i&&Object.keys(i).length>0;
}
function cargarEnMemoria(){
  CACHE.dias    = getFromCache('dias')    || [];
  CACHE.capital = getFromCache('capital') || [];
  CACHE.interes = getFromCache('interes') || {};
  CACHE.banner  = getFromCache('banner')  || { activo:false, texto:'' };
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NORMALIZACIÃ“N â€” igual que el test
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function norm(v){
  if(typeof v==='number') return isFinite(v)?v:NaN;
  if(v==null||v==='') return NaN;
  let s=String(v).trim().replace(/%/g,'').replace(/,/g,'.');
  const p=s.split('.');
  if(p.length>2) s=p.slice(0,-1).join('')+'.'+p[p.length-1];
  const n=parseFloat(s);
  return isNaN(n)||!isFinite(n)?NaN:n;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FETCH SHEETS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function fetchSheet(nombre){
  const url=`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(nombre)}`;
  const r=await fetch(url,{cache:'no-store'});
  if(!r.ok) throw new Error(`HTTP ${r.status} â€” "${nombre}"`);
  const txt=await r.text();
  const json=JSON.parse(txt.replace(/^[\s\S]*?setResponse\(/,'').replace(/\);[\s\S]*$/,''));
  return json.table?.rows||[];
}
async function leerColumnaA(nombre){
  const rows=await fetchSheet(nombre);
  const vals=[];
  rows.forEach((row,i)=>{
    const v=row?.c?.[0]?.v;
    if(i===0&&isNaN(parseFloat(v))) return;
    const n=norm(v);
    if(!isNaN(n)) vals.push(n);
  });
  return vals;
}
async function leerInteres(dias){
  const rows=await fetchSheet('Interes');
  const vals=[];
  rows.forEach((row,i)=>{
    const v=row?.c?.[0]?.v, f=row?.c?.[0]?.f||'';
    if(i===0&&isNaN(parseFloat(v))) return;
    let n=norm(v);
    if(isNaN(n)||n>1000) return;
    if(f.includes('%')||(n>0&&n<1)) n*=100;
    if(n<0||n>100) return;
    vals.push(n);
  });
  const obj={};
  const len=Math.min(dias.length,vals.length);
  for(let i=0;i<len;i++) obj[dias[i]]=vals[i];
  return obj;
}
async function leerBanner(){
  try{
    const rows=await fetchSheet('Banner');
    if(rows.length>1){ const t=rows[1]?.c?.[0]?.v||''; return{activo:t.trim()!=='',texto:t}; }
  }catch(_){}
  return{activo:false,texto:''};
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SYNC SILENCIOSO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function sincronizar(){
  if(syncActivo||!navigator.onLine) return;
  syncActivo=true;
  setDot('busy'); setStrip(8);
  try{
    const dias=await leerColumnaA('Dias');
    if(!dias.length) throw new Error('Dias vacÃ­o');
    saveToCache('dias',dias); setStrip(30);

    const capital=await leerColumnaA('Capital');
    if(!capital.length) throw new Error('Capital vacÃ­o');
    saveToCache('capital',capital); setStrip(55);

    const interes=await leerInteres(dias);
    if(!Object.keys(interes).length) throw new Error('Interes vacÃ­o');
    saveToCache('interes',interes); setStrip(82);

    const banner=await leerBanner();
    saveToCache('banner',banner); setStrip(100);

    cargarEnMemoria();
    // Refrescar chips manteniendo selecciÃ³n activa
    renderDias(true); renderCapital(true); renderBanner();
    // Re-calcular si habÃ­a selecciÃ³n completa
    autoCalcular();

    setDot('ok');
    setTimeout(()=>setStrip(null),500);
  }catch(err){
    setDot(navigator.onLine?'ok':'off');
    setStrip(null);
    if(!cacheOk()) toast('Error al cargar datos: '+err.message, 4000);
  }
  syncActivo=false;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RENDER CHIPS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderDias(mantener=false){
  const el=$('chipsDias');
  if(!CACHE.dias.length){
    el.innerHTML='<div class="empty"><span>ğŸ“…</span>Cargando plazosâ€¦</div>'; return;
  }
  if(mantener && SEL.dias && !CACHE.dias.includes(SEL.dias)) SEL.dias=null;
  el.innerHTML='';
  CACHE.dias.forEach(d=>{
    const c=mk('div','chip'+(SEL.dias===d?' on':''));
    c.textContent=d+' dÃ­as';
    c.onclick=()=>selDias(d);
    el.appendChild(c);
  });
}
function renderCapital(mantener=false){
  const el=$('chipsCapital');
  if(!CACHE.capital.length){
    el.innerHTML='<div class="empty"><span>ğŸ’°</span>Cargando montosâ€¦</div>'; return;
  }
  if(mantener && SEL.capital && !CACHE.capital.includes(SEL.capital)) SEL.capital=null;
  el.innerHTML='';
  CACHE.capital.forEach(c=>{
    const chip=mk('div','chip'+(SEL.capital===c?' on':''));
    chip.textContent='$'+c.toLocaleString('es-MX');
    chip.onclick=()=>selCapital(c);
    el.appendChild(chip);
  });
}
function renderBanner(){
  const b=CACHE.banner;
  if(b?.activo&&b.texto?.trim()){ $('bannerTxt').textContent=b.texto; $('banner').classList.add('show'); }
  else $('banner').classList.remove('show');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SELECCIÃ“N â†’ dispara cÃ¡lculo al instante
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function selDias(d){
  SEL.dias=d; wrSS('sp_sel',SEL);
  $$('#chipsDias .chip').forEach(c=>c.classList.toggle('on',parseInt(c.textContent)===d));
  autoCalcular();
}
function selCapital(c){
  SEL.capital=c; wrSS('sp_sel',SEL);
  $$('#chipsCapital .chip').forEach(el=>el.classList.toggle('on',el.textContent==='$'+c.toLocaleString('es-MX')));
  autoCalcular();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CÃLCULO AUTOMÃTICO EN TIEMPO REAL
   â€” Se ejecuta en cada selecciÃ³n
   â€” Sin botÃ³n, sin delay
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function autoCalcular(){
  const { dias, capital } = SEL;

  // Estado parcial: solo uno seleccionado
  if(!dias && !capital){
    resetResultado('Selecciona plazo y capital'); return;
  }
  if(!dias){
    resetResultado('Selecciona un plazo'); return;
  }
  if(!capital){
    resetResultado('Selecciona el capital'); return;
  }

  const interesPorc = CACHE.interes[dias];
  if(interesPorc===undefined||interesPorc===null){
    resetResultado('Sin tasa para ese plazo'); return;
  }

  /* FÃ“RMULA â€” idÃ©ntica al test */
  const interesTotal = capital * (interesPorc / 100);
  const totalPagar   = capital + interesTotal;
  const pagoDiario   = totalPagar / dias;

  const data = { dias, capital, interesPorc, interesTotal, totalPagar, pagoDiario };

  // Persistir en session para restaurar en recarga
  wrSS('sp_last', data);

  mostrarResultado(data);
}

function fmt(n){
  return '$'+n.toLocaleString('es-MX',{minimumFractionDigits:2,maximumFractionDigits:2});
}

function mostrarResultado({ dias, capital, interesPorc, interesTotal, totalPagar, pagoDiario }){
  const hora = new Date().toLocaleTimeString('es-MX',{hour:'2-digit',minute:'2-digit'});

  // Activar estilos del panel
  $('resultPanel').classList.add('active');
  $('rHead').classList.add('active');

  // Total destacado
  const rTot=$('rTotal');
  rTot.textContent=fmt(totalPagar);
  rTot.classList.add('active');

  // SubtÃ­tulo
  const rSub=$('rSub');
  rSub.textContent=`${dias} dÃ­as Â· tasa ${interesPorc}%`;
  rSub.classList.add('active');

  // MÃ©tricas
  setVal('rCapital', fmt(capital),         false, false);
  setVal('rTasa',    interesPorc+'%',       true,  false);
  setVal('rInteres', fmt(interesTotal),     false, true);
  setVal('rDiario',  fmt(pagoDiario),       true,  false);

  // Footer
  $('rDot').classList.add('show');
  $('rFooter').textContent = 'Calculado con cachÃ© Â· '+hora;
}

function setVal(id, val, isAcc, isGold){
  const el=$(id);
  el.textContent=val;
  el.classList.add('show');
  if(isAcc)  el.classList.add('ac');
  if(isGold) el.classList.add('go');
}

function resetResultado(msg){
  $('resultPanel').classList.remove('active');
  $('rHead').classList.remove('active');
  $('rTotal').textContent='â€”'; $('rTotal').classList.remove('active');
  $('rSub').textContent=msg||'Selecciona plazo y capital'; $('rSub').classList.remove('active');
  ['rCapital','rTasa','rInteres','rDiario'].forEach(id=>{
    const el=$(id); el.textContent='â€”';
    el.classList.remove('show','ac','go');
  });
  $('rDot').classList.remove('show');
  $('rFooter').textContent='Esperando selecciÃ³nâ€¦';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UI UTILS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const $  = id  => document.getElementById(id);
const $$ = sel => document.querySelectorAll(sel);
const mk = (t,c)=>{ const e=document.createElement(t); if(c) e.className=c; return e; };

function setDot(m){ $('sdot').className='sdot '+(m||''); }
function setStrip(pct){
  const f=$('strip');
  if(pct===null){ f.classList.remove('on'); setTimeout(()=>{ f.style.width='0%'; },400); return; }
  f.classList.add('on'); f.style.width=pct+'%';
}

let _tT;
function toast(msg,ms=2800){
  clearTimeout(_tT);
  const el=$('toast'); el.textContent=msg; el.classList.add('show');
  _tT=setTimeout(()=>el.classList.remove('show'),ms);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT AUTOMÃTICO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function init(){
  setDot(navigator.onLine?'ok':'off');

  const hayCache = cacheOk();

  if(hayCache){
    /* â”€â”€ Ruta rÃ¡pida: datos en cachÃ©, renderizar al instante â”€â”€ */
    cargarEnMemoria();
    renderDias();
    renderCapital();
    renderBanner();

    /* Restaurar selecciÃ³n y resultado de la sesiÃ³n anterior */
    const lastResult = rdSS('sp_last');
    if(SEL.dias && SEL.capital && lastResult){
      autoCalcular(); // recalcular con los datos actuales del cachÃ©
    } else if(SEL.dias || SEL.capital){
      autoCalcular(); // estado parcial â†’ guÃ­a al usuario
    }

    /* Sync silencioso si el cachÃ© estÃ¡ vencido */
    const ts=getCacheTs('dias');
    const stale=!ts||(Date.now()-ts)>CACHE_TTL;
    if(stale && navigator.onLine) sincronizar();

  } else {
    /* â”€â”€ Primera vez o cachÃ© borrado â”€â”€ */
    if(navigator.onLine){
      await sincronizar();
      if(cacheOk()){
        cargarEnMemoria();
        renderDias(); renderCapital(); renderBanner();
      } else {
        $('chipsDias').innerHTML='<div class="empty"><span>âš ï¸</span>Error al cargar datos.<br>Verifica conexiÃ³n.</div>';
        $('chipsCapital').innerHTML='';
      }
    } else {
      $('chipsDias').innerHTML='<div class="empty"><span>ğŸ“µ</span>Sin conexiÃ³n.<br>Los datos cargarÃ¡n al reconectar.</div>';
      $('chipsCapital').innerHTML='';
    }
  }

  /* Listeners de red â€” completamente automÃ¡ticos */
  window.addEventListener('online', ()=>{
    setDot('busy');
    sincronizar().then(()=>{
      if(cacheOk()){ cargarEnMemoria(); renderDias(true); renderCapital(true); renderBanner(); autoCalcular(); }
    });
  });
  window.addEventListener('offline', ()=>{ setDot('off'); });
}

init();
</script>
</body>
</html>
