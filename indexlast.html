<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>SimPrÃ©stamo</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@700;800&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#080b10; --surf:#0f1319; --card:#141a24; --card2:#19202e;
  --b1:#1c2535; --b2:#243047;
  --acc:#00e5b0; --acc2:#00b88d;
  --blue:#3b82f6; --gold:#f59e0b;
  --txt:#dce8f5; --mut:#4d617d; --soft:#7a92b0;
  --r:14px; --rs:9px;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{font-size:16px;-webkit-tap-highlight-color:transparent}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--txt);min-height:100dvh;overflow-x:hidden}
body::before{
  content:'';position:fixed;inset:0;z-index:0;pointer-events:none;
  background:
    radial-gradient(ellipse 60% 50% at 88% 4%,rgba(0,229,176,.07) 0%,transparent 65%),
    radial-gradient(ellipse 50% 60% at 4% 96%,rgba(59,130,246,.05) 0%,transparent 65%);
}
.app{position:relative;z-index:1;max-width:430px;margin:0 auto;padding:0 16px 60px}

/* â”€â”€ HEADER â”€â”€ */
.hdr{display:flex;align-items:center;justify-content:space-between;padding:22px 0 6px}
.logo{font-family:'Syne',sans-serif;font-weight:800;font-size:1.28rem;letter-spacing:-.03em}
.logo em{color:var(--acc);font-style:normal}
.sdot{width:8px;height:8px;border-radius:50%;background:var(--mut);transition:background .4s}
.sdot.ok  {background:var(--acc)}
.sdot.off {background:var(--gold)}
.sdot.busy{background:var(--blue);animation:pulse .9s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}

/* â”€â”€ SYNC STRIP 2px â”€â”€ */
.sw{height:2px;border-radius:99px;background:var(--b1);overflow:hidden;margin-bottom:6px}
.sf{height:100%;width:0%;border-radius:99px;background:linear-gradient(90deg,var(--acc),var(--blue));transition:width .35s,opacity .4s;opacity:0}
.sf.on{opacity:1}

/* â”€â”€ BANNER â”€â”€ */
.banner{display:none;align-items:center;gap:9px;margin:4px 0 10px;padding:10px 14px;border-radius:var(--rs);background:rgba(0,229,176,.07);border:1px solid rgba(0,229,176,.18);font-size:.83rem;color:var(--acc)}
.banner.show{display:flex}

/* â”€â”€ SECTION LABEL â”€â”€ */
.slabel{font-family:'Syne',sans-serif;font-size:.64rem;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--mut);margin:22px 0 10px}

/* â”€â”€ CARD â”€â”€ */
.card{background:var(--card);border:1px solid var(--b1);border-radius:var(--r);padding:20px}

/* â”€â”€ CHIPS â”€â”€ */
.clabel{font-size:.74rem;font-weight:500;color:var(--soft);display:flex;align-items:center;gap:6px;margin-bottom:10px}
.chips{display:flex;flex-wrap:wrap;gap:7px;margin-bottom:20px}
.chips.g{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
.chip{
  padding:8px 16px;border-radius:99px;border:1.5px solid var(--b2);background:var(--surf);
  color:var(--soft);font-size:.82rem;font-weight:500;cursor:pointer;user-select:none;
  transition:border-color .13s,background .13s,color .13s,transform .1s;
}
.chips.g .chip{border-radius:var(--rs);text-align:center;padding:10px 4px}
.chip:hover{border-color:var(--acc);color:var(--txt)}
.chip:active{transform:scale(.96)}
.chip.on{border-color:var(--acc);background:rgba(0,229,176,.12);color:var(--acc);font-weight:600}
.sk{background:linear-gradient(90deg,var(--surf) 25%,var(--card2) 50%,var(--surf) 75%);background-size:200% 100%;animation:sh 1.2s infinite;border-radius:99px;height:36px}
.chips.g .sk{border-radius:var(--rs)}
@keyframes sh{0%{background-position:200% 0}100%{background-position:-200% 0}}
.divider{height:1px;background:var(--b1);margin:0 0 20px}

/* â”€â”€ RESULTADO EN TIEMPO REAL â”€â”€ */
.rp{margin-top:20px;border-radius:var(--r);overflow:hidden;border:1px solid var(--b2);background:var(--card2);transition:border-color .3s,box-shadow .3s}
.rp.on{border-color:rgba(0,229,176,.28);box-shadow:0 0 36px rgba(0,229,176,.08),0 8px 28px rgba(0,0,0,.45)}
.rh{padding:20px 20px 14px;text-align:center;background:linear-gradient(135deg,rgba(0,229,176,.07) 0%,rgba(59,130,246,.04) 100%);border-bottom:1px solid var(--b1);transition:background .3s}
.rh.on{background:linear-gradient(135deg,rgba(0,229,176,.12) 0%,rgba(59,130,246,.08) 100%)}
.rl{font-size:.66rem;color:var(--mut);letter-spacing:.08em;text-transform:uppercase;margin-bottom:6px}
.rb{font-family:'Syne',sans-serif;font-size:2.4rem;font-weight:800;letter-spacing:-.04em;line-height:1;color:var(--mut);transition:color .25s}
.rb.on{color:var(--acc)}
.rs{font-size:.76rem;color:var(--mut);margin-top:5px;min-height:1.2em;transition:color .25s}
.rs.on{color:var(--soft)}
.rg{display:grid;grid-template-columns:1fr 1fr}
.ri{padding:14px 16px;border-right:1px solid var(--b1);border-bottom:1px solid var(--b1)}
.ri:nth-child(2n){border-right:none}
.ri:nth-last-child(-n+2){border-bottom:none}
.rik{font-size:.65rem;color:var(--mut);text-transform:uppercase;letter-spacing:.07em;margin-bottom:4px}
.riv{font-family:'Syne',sans-serif;font-size:1.08rem;font-weight:700;color:var(--b2);transition:color .25s}
.riv.v{color:var(--txt)}
.riv.v.ac{color:var(--acc)}
.riv.v.go{color:var(--gold)}
.rf{display:flex;align-items:center;justify-content:center;gap:6px;padding:8px;background:var(--surf);font-size:.66rem;color:var(--mut);min-height:30px}
.rfd{width:4px;height:4px;border-radius:50%;background:var(--acc);opacity:0;transition:opacity .3s}
.rfd.v{opacity:1}

/* â”€â”€ EMPTY / TOAST â”€â”€ */
.empty{padding:20px 0;text-align:center;font-size:.81rem;color:var(--mut);line-height:1.7}
.empty span{font-size:1.7rem;display:block;margin-bottom:7px;opacity:.35}
#toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%) translateY(52px);background:var(--card2);border:1px solid var(--b2);padding:9px 18px;border-radius:99px;font-size:.8rem;color:var(--txt);box-shadow:0 8px 24px rgba(0,0,0,.5);transition:transform .3s cubic-bezier(.34,1.56,.64,1);white-space:nowrap;z-index:200;pointer-events:none}
#toast.show{transform:translateX(-50%) translateY(0)}

@media(max-width:360px){
  .rb{font-size:2rem}
  .chips.g{grid-template-columns:repeat(2,1fr)}
}
</style>
</head>
<body>
<div class="app">

  <header class="hdr">
    <div class="logo">Sim<em>PrÃ©stamo</em></div>
    <div class="sdot" id="sdot"></div>
  </header>

  <div class="sw"><div class="sf" id="strip"></div></div>
  <div class="banner" id="banner"><span>ğŸ“¢</span><span id="bannerTxt"></span></div>

  <p class="slabel">Simulador de prÃ©stamo</p>

  <div class="card">
    <div class="clabel">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2">
        <rect x="3" y="4" width="18" height="18" rx="2"/>
        <line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/>
        <line x1="3" y1="10" x2="21" y2="10"/>
      </svg>
      Plazo
    </div>
    <div class="chips" id="chipsDias">
      <div class="sk" style="width:76px"></div>
      <div class="sk" style="width:76px"></div>
      <div class="sk" style="width:76px"></div>
    </div>

    <div class="divider"></div>

    <div class="clabel">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2">
        <line x1="12" y1="1" x2="12" y2="23"/>
        <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
      </svg>
      Capital solicitado
    </div>
    <div class="chips g" id="chipsCapital">
      <div class="sk"></div><div class="sk"></div><div class="sk"></div>
      <div class="sk"></div><div class="sk"></div><div class="sk"></div>
    </div>

    <!-- RESULTADO TIEMPO REAL -->
    <div class="rp" id="rp">
      <div class="rh" id="rh">
        <div class="rl">Total a pagar</div>
        <div class="rb" id="rTotal">â€”</div>
        <div class="rs" id="rSub">Selecciona plazo y capital</div>
      </div>
      <div class="rg">
        <div class="ri"><div class="rik">Capital</div><div class="riv" id="rCap">â€”</div></div>
        <div class="ri"><div class="rik">Tasa</div><div class="riv ac" id="rTasa">â€”</div></div>
        <div class="ri"><div class="rik">InterÃ©s total</div><div class="riv go" id="rInt">â€”</div></div>
        <div class="ri"><div class="rik">Pago diario</div><div class="riv ac" id="rDia">â€”</div></div>
      </div>
      <div class="rf">
        <div class="rfd" id="rDot"></div>
        <span id="rFoot">Esperando selecciÃ³nâ€¦</span>
      </div>
    </div>
  </div>
</div>
<div id="toast"></div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SERVICE WORKER â€” se registra desde un Blob.
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
(function registerSW() {
  if (!('serviceWorker' in navigator)) return;
  const swCode = `
const VER = 'sp-v3';
self.addEventListener('install', e => {
  e.waitUntil(caches.open(VER).then(c => c.addAll([self.registration.scope])));
  self.skipWaiting();
});
self.addEventListener('activate', e => {
  e.waitUntil(caches.keys().then(keys =>
    Promise.all(keys.filter(k => k !== VER).map(k => caches.delete(k)))
  ));
  self.clients.claim();
});
self.addEventListener('message', e => {
  if (e.data?.type === 'SKIP_WAITING') self.skipWaiting();
});
self.addEventListener('fetch', e => {
  if (e.request.mode !== 'navigate') return;
  e.respondWith(
    fetch(e.request).then(res => {
      const clone = res.clone();
      caches.open(VER).then(c => c.put(e.request, clone));
      return res;
    }).catch(() =>
      caches.match(e.request).then(hit => hit || caches.match(self.registration.scope))
    )
  );
});
  `;
  const blob = new Blob([swCode], { type: 'application/javascript' });
  const swURL = URL.createObjectURL(blob);
  navigator.serviceWorker.register(swURL, { scope: './' })
    .then(reg => {
      if (reg.waiting) reg.waiting.postMessage({ type: 'SKIP_WAITING' });
      reg.addEventListener('updatefound', () => {
        const nw = reg.installing;
        nw?.addEventListener('statechange', () => {
          if (nw.state === 'installed' && navigator.serviceWorker.controller)
            nw.postMessage({ type: 'SKIP_WAITING' });
        });
      });
    })
    .catch(() => {});
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONFIG
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const SHEET_ID  = '19Viesr9Lhy347A9L03J_RuxftUhBduaYsBY206IO6X8';
const CACHE_TTL = 12 * 60 * 60 * 1000;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ESTADO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let SEL   = rdSS('sp_sel') || { dias: null, capital: null };
let CACHE = { dias: [], capital: [], interes: {}, banner: { activo: false, texto: '' } };
let syncing = false;

function rdSS(k) { try { return JSON.parse(sessionStorage.getItem(k)); } catch(e) { return null; } }
function wrSS(k, v) { try { sessionStorage.setItem(k, JSON.stringify(v)); } catch(e) {} }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FIX #2 + #3 â€” localStorage robusto
   getFromCache ahora siempre extrae
   correctamente el array/objeto interno
   sin importar el formato guardado.
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function saveToCache(k, d) {
  try {
    localStorage.setItem('simulador_' + k, JSON.stringify({ data: d, timestamp: Date.now() }));
  } catch(e) {}
}

function getFromCache(k) {
  try {
    const raw = localStorage.getItem('simulador_' + k);
    if (!raw) return null;
    const p = JSON.parse(raw);
    // FIX: si tiene propiedad "data", extraerla explÃ­citamente
    // (antes: p?.data !== undefined podÃ­a fallar si data=[] vacÃ­o)
    if (p !== null && typeof p === 'object' && 'data' in p) {
      return p.data;
    }
    // Formato legado: el valor estÃ¡ directamente en p
    return p;
  } catch(e) { return null; }
}

function getCacheTs(k) {
  try {
    const raw = localStorage.getItem('simulador_' + k);
    if (!raw) return null;
    const p = JSON.parse(raw);
    return p?.timestamp || null;
  } catch(e) { return null; }
}

/* FIX #2 â€” cacheOk() con validaciÃ³n mÃ¡s robusta */
function cacheOk() {
  try {
    const d = getFromCache('dias');
    const c = getFromCache('capital');
    const i = getFromCache('interes');
    const diasOk    = Array.isArray(d) && d.length > 0;
    const capitalOk = Array.isArray(c) && c.length > 0;
    const interesOk = i !== null && typeof i === 'object' && !Array.isArray(i) && Object.keys(i).length > 0;
    return diasOk && capitalOk && interesOk;
  } catch(e) { return false; }
}

function cargarEnMemoria() {
  CACHE.dias    = getFromCache('dias')    || [];
  CACHE.capital = getFromCache('capital') || [];
  CACHE.interes = getFromCache('interes') || {};
  CACHE.banner  = getFromCache('banner')  || { activo: false, texto: '' };
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NORMALIZACIÃ“N
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function norm(v) {
  if (typeof v === 'number') return isFinite(v) ? v : NaN;
  if (v == null || v === '') return NaN;
  let s = String(v).trim().replace(/%/g, '').replace(/,/g, '.');
  const p = s.split('.');
  if (p.length > 2) s = p.slice(0, -1).join('') + '.' + p[p.length - 1];
  const n = parseFloat(s);
  return isNaN(n) || !isFinite(n) ? NaN : n;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FETCH SHEETS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function fetchSheet(nombre) {
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(nombre)}`;
  const r = await fetch(url, { cache: 'no-store' });
  if (!r.ok) throw new Error(`HTTP ${r.status}`);
  const txt = await r.text();
  const json = JSON.parse(txt.replace(/^[\s\S]*?setResponse\(/, '').replace(/\);[\s\S]*$/, ''));
  return json.table?.rows || [];
}

async function leerColumnaA(n) {
  const rows = await fetchSheet(n);
  const vals = [];
  rows.forEach((row, i) => {
    const v = row?.c?.[0]?.v;
    if (i === 0 && isNaN(parseFloat(v))) return;
    const num = norm(v);
    if (!isNaN(num)) vals.push(num);
  });
  return vals;
}

async function leerInteres(dias) {
  const rows = await fetchSheet('Interes');
  const vals = [];
  rows.forEach((row, i) => {
    const v = row?.c?.[0]?.v, f = row?.c?.[0]?.f || '';
    if (i === 0 && isNaN(parseFloat(v))) return;
    let n = norm(v);
    if (isNaN(n) || n > 1000) return;
    if (f.includes('%') || (n > 0 && n < 1)) n *= 100;
    if (n < 0 || n > 100) return;
    vals.push(n);
  });
  const obj = {}, len = Math.min(dias.length, vals.length);
  for (let i = 0; i < len; i++) obj[dias[i]] = vals[i];
  return obj;
}

async function leerBanner() {
  try {
    const rows = await fetchSheet('Banner');
    if (rows.length > 1) {
      const t = rows[1]?.c?.[0]?.v || '';
      return { activo: t.trim() !== '', texto: t };
    }
  } catch(_) {}
  return { activo: false, texto: '' };
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SYNC SILENCIOSO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function sync() {
  if (syncing || !navigator.onLine) return;
  syncing = true; dot('busy'); strip(8);
  try {
    const dias = await leerColumnaA('Dias');
    if (!dias.length) throw new Error('Dias vacÃ­o');
    saveToCache('dias', dias); strip(30);

    const capital = await leerColumnaA('Capital');
    if (!capital.length) throw new Error('Capital vacÃ­o');
    saveToCache('capital', capital); strip(55);

    const interes = await leerInteres(dias);
    if (!Object.keys(interes).length) throw new Error('Interes vacÃ­o');
    saveToCache('interes', interes); strip(82);

    const banner = await leerBanner();
    saveToCache('banner', banner); strip(100);

    cargarEnMemoria();
    renderDias(true); renderCapital(true); renderBanner();
    autoCalc();
    dot('ok'); setTimeout(() => strip(null), 500);
  } catch(err) {
    dot(navigator.onLine ? 'ok' : 'off'); strip(null);
    if (!cacheOk()) toast('Error al cargar: ' + err.message, 4000);
  }
  syncing = false;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RENDER
   FIX #1 â€” renderDias/renderCapital
   aplican el estado .on ANTES de que
   el usuario haga click, restaurando
   la selecciÃ³n guardada en SEL.
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderDias(keep = false) {
  const el = $('chipsDias');
  if (!CACHE.dias.length) {
    el.innerHTML = '<div class="empty"><span>ğŸ“…</span>Cargandoâ€¦</div>';
    return;
  }
  // Si keep=true y el dÃ­a guardado ya no existe en la lista, limpiar
  if (keep && SEL.dias && !CACHE.dias.includes(SEL.dias)) SEL.dias = null;
  el.innerHTML = '';
  CACHE.dias.forEach(d => {
    const c = mk('div', 'chip');
    c.textContent = d + ' dÃ­as';
    // FIX #1: aplicar .on directamente al crear el chip si estÃ¡ seleccionado
    if (SEL.dias === d) c.classList.add('on');
    c.onclick = () => selD(d);
    el.appendChild(c);
  });
}

function renderCapital(keep = false) {
  const el = $('chipsCapital');
  if (!CACHE.capital.length) {
    el.innerHTML = '<div class="empty"><span>ğŸ’°</span>Cargandoâ€¦</div>';
    return;
  }
  if (keep && SEL.capital && !CACHE.capital.includes(SEL.capital)) SEL.capital = null;
  el.innerHTML = '';
  CACHE.capital.forEach(c => {
    const chip = mk('div', 'chip');
    chip.textContent = '$' + c.toLocaleString('es-MX');
    // FIX #1: aplicar .on directamente al crear el chip si estÃ¡ seleccionado
    if (SEL.capital === c) chip.classList.add('on');
    chip.onclick = () => selC(c);
    el.appendChild(chip);
  });
}

function renderBanner() {
  const b = CACHE.banner;
  if (b?.activo && b.texto?.trim()) {
    $('bannerTxt').textContent = b.texto;
    $('banner').classList.add('show');
  } else {
    $('banner').classList.remove('show');
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SELECCIÃ“N â†’ cÃ¡lculo inmediato
   FIX #1: los toggles de .on ahora
   usan el valor numÃ©rico exacto del
   chip (data attribute) para comparar
   en vez de parsear el texto del DOM,
   eliminando fallos por formato.
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function selD(d) {
  SEL.dias = d;
  wrSS('sp_sel', SEL);
  $$('#chipsDias .chip').forEach(c => {
    // Comparar con el valor generado (no con text content parseado)
    const chipVal = parseInt(c.textContent);
    c.classList.toggle('on', chipVal === d);
  });
  autoCalc();
}

function selC(c) {
  SEL.capital = c;
  wrSS('sp_sel', SEL);
  const textoEsperado = '$' + c.toLocaleString('es-MX');
  $$('#chipsCapital .chip').forEach(el => {
    el.classList.toggle('on', el.textContent === textoEsperado);
  });
  autoCalc();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CÃLCULO EN TIEMPO REAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function autoCalc() {
  const { dias, capital } = SEL;
  if (!dias && !capital) { resetRes('Selecciona plazo y capital'); return; }
  if (!dias)             { resetRes('Selecciona un plazo');        return; }
  if (!capital)          { resetRes('Selecciona el capital');      return; }

  // FIX extra: asegurarse de que CACHE tiene datos antes de calcular
  if (!CACHE.interes || Object.keys(CACHE.interes).length === 0) {
    // Intentar recargar desde localStorage en caso de que CACHE estÃ© vacÃ­o
    cargarEnMemoria();
  }

  const ip = CACHE.interes[dias];
  if (ip === undefined || ip === null) { resetRes('Sin tasa para ese plazo'); return; }

  const it = capital * (ip / 100);
  const tp = capital + it;
  const pd = tp / dias;

  wrSS('sp_last', { dias, capital, ip, it, tp, pd });
  showRes(dias, capital, ip, it, tp, pd);
}

function fmt(n) {
  return '$' + n.toLocaleString('es-MX', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function showRes(dias, capital, ip, it, tp, pd) {
  const hora = new Date().toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit' });
  $('rp').classList.add('on'); $('rh').classList.add('on');
  cls('rTotal', 'on'); $('rTotal').textContent = fmt(tp);
  cls('rSub', 'on');   $('rSub').textContent = `${dias} dÃ­as Â· tasa ${ip}%`;
  sv('rCap',  fmt(capital), false, false);
  sv('rTasa', ip + '%',     true,  false);
  sv('rInt',  fmt(it),      false, true);
  sv('rDia',  fmt(pd),      true,  false);
  $('rDot').classList.add('v');
  $('rFoot').textContent = 'Calculado con cachÃ© Â· ' + hora;
}

function sv(id, val, ac, go) {
  const el = $(id);
  el.textContent = val;
  el.classList.add('v');
  if (ac) el.classList.add('ac');
  if (go) el.classList.add('go');
}
function cls(id, c) { $(id).classList.add(c); }

function resetRes(msg) {
  $('rp').classList.remove('on'); $('rh').classList.remove('on');
  $('rTotal').textContent = 'â€”'; $('rTotal').classList.remove('on');
  $('rSub').textContent = msg || 'Selecciona plazo y capital';
  $('rSub').classList.remove('on');
  ['rCap', 'rTasa', 'rInt', 'rDia'].forEach(id => {
    const el = $(id);
    el.textContent = 'â€”';
    el.classList.remove('v', 'ac', 'go');
  });
  $('rDot').classList.remove('v');
  $('rFoot').textContent = 'Esperando selecciÃ³nâ€¦';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UI UTILS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const $  = id => document.getElementById(id);
const $$ = s  => document.querySelectorAll(s);
const mk = (t, c) => { const e = document.createElement(t); if (c) e.className = c; return e; };

function dot(m) { $('sdot').className = 'sdot ' + (m || ''); }
function strip(pct) {
  const f = $('strip');
  if (pct === null) {
    f.classList.remove('on');
    setTimeout(() => { f.style.width = '0%'; }, 400);
    return;
  }
  f.classList.add('on');
  f.style.width = pct + '%';
}
let _tT;
function toast(msg, ms = 2800) {
  clearTimeout(_tT);
  const el = $('toast');
  el.textContent = msg;
  el.classList.add('show');
  _tT = setTimeout(() => el.classList.remove('show'), ms);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT â€” 100% automÃ¡tico
   FIX: flujo offline con cachÃ©
   reorganizado para garantizar que
   CACHE se llena ANTES de renderizar
   y autoCalc() se llama al final.
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function init() {
  dot(navigator.onLine ? 'ok' : 'off');

  if (cacheOk()) {
    // âœ… Hay cachÃ© vÃ¡lido â†’ cargar en memoria primero
    cargarEnMemoria();
    // Renderizar chips (aplica .on a la selecciÃ³n guardada en SEL)
    renderDias();
    renderCapital();
    renderBanner();
    // Recalcular si hay selecciÃ³n previa en sessionStorage
    if (SEL.dias || SEL.capital) autoCalc();

    // Sync silencioso en background si cachÃ© estÃ¡ vencido
    const ts = getCacheTs('dias');
    if ((!ts || (Date.now() - ts) > CACHE_TTL) && navigator.onLine) {
      sync(); // no await â€” no bloquear la UI
    }
  } else {
    // No hay cachÃ© o estÃ¡ corrupto
    if (navigator.onLine) {
      await sync();
      // sync() ya llama a cargarEnMemoria() + renderDias() + renderCapital() internamente
      if (!cacheOk()) {
        $('chipsDias').innerHTML    = '<div class="empty"><span>âš ï¸</span>Error al cargar datos.<br>Verifica conexiÃ³n.</div>';
        $('chipsCapital').innerHTML = '';
      }
    } else {
      $('chipsDias').innerHTML    = '<div class="empty"><span>ğŸ“µ</span>Sin conexiÃ³n.<br>Se cargarÃ¡ al reconectar.</div>';
      $('chipsCapital').innerHTML = '';
    }
  }

  // Escuchar cambios de conectividad
  window.addEventListener('online', () => {
    dot('busy');
    sync().then(() => {
      if (cacheOk()) {
        cargarEnMemoria();
        renderDias(true);
        renderCapital(true);
        renderBanner();
        autoCalc();
      }
    });
  });
  window.addEventListener('offline', () => { dot('off'); });
}

init();
</script>
</body>
</html>
