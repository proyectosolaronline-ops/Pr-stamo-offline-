<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Solicitar Préstamo</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@700;800&family=DM+Sans:ital,wght@0,300;0,400;0,500;1,400&display=swap" rel="stylesheet">
<style>
/* TODO tu CSS original se mantiene intacto - no lo toco */
:root{--bg:#080b10;--surf:#0f1319;--card:#141a24;--card2:#19202e;--b1:#1c2535;--b2:#243047;--acc:#00e5b0;--acc2:#00b88d;--blue:#3b82f6;--gold:#f59e0b;--red:#f43f5e;--txt:#dce8f5;--mut:#4d617d;--soft:#7a92b0;--r:14px;--rs:9px}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{font-size:16px;-webkit-tap-highlight-color:transparent}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--txt);min-height:100dvh;overflow-x:hidden}
body::before{content:'';position:fixed;inset:0;z-index:0;pointer-events:none;background:radial-gradient(ellipse 70% 50% at 90% 5%,rgba(0,229,176,.08) 0%,transparent 60%),radial-gradient(ellipse 50% 60% at 5% 95%,rgba(59,130,246,.06) 0%,transparent 60%)}
.wrap{position:relative;z-index:1;max-width:430px;margin:0 auto;padding:0 16px 120px}
.hdr{display:flex;align-items:center;justify-content:space-between;padding:22px 0 6px}
.logo{font-family:'Syne',sans-serif;font-weight:800;font-size:1.28rem;letter-spacing:-.03em}
.logo em{color:var(--acc);font-style:normal}
.back-btn{display:flex;align-items:center;gap:6px;font-size:.78rem;color:var(--soft);background:none;border:none;cursor:pointer;transition:color .2s;padding:6px 0}
.back-btn:hover{color:var(--acc)}
.sdot{width:8px;height:8px;border-radius:50%;background:var(--mut);transition:background .4s}
.sdot.ok{background:var(--acc)}.sdot.off{background:var(--gold)}.sdot.busy{background:var(--blue);animation:blink .9s infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
.resumen{background:var(--card);border:1px solid var(--b1);border-radius:var(--r);padding:18px 20px;margin:12px 0 22px;position:relative;overflow:hidden}
.resumen::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--acc),var(--blue))}
.res-title{font-size:.62rem;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--mut);margin-bottom:14px;font-family:'Syne',sans-serif}
.res-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.res-item .lbl{font-size:.65rem;color:var(--mut);text-transform:uppercase;letter-spacing:.07em;margin-bottom:3px}
.res-item .val{font-family:'Syne',sans-serif;font-size:1.05rem;font-weight:700;color:var(--txt)}
.res-item .val.acc{color:var(--acc)}.res-item .val.gold{color:var(--gold)}
.res-total{margin-top:14px;padding-top:14px;border-top:1px solid var(--b1);display:flex;justify-content:space-between;align-items:center}
.res-total .lbl{font-size:.75rem;color:var(--soft);font-weight:500}
.res-total .val{font-family:'Syne',sans-serif;font-size:1.55rem;font-weight:800;color:var(--acc);letter-spacing:-.03em}
.no-calc{text-align:center;padding:14px 0;font-size:.83rem;color:var(--mut);line-height:1.7}
.no-calc a{color:var(--acc);text-decoration:none}
.cliente-badge{display:none;margin-top:10px;padding:8px 12px;background:rgba(0,229,176,.08);border:1px solid rgba(0,229,176,.2);border-radius:8px;font-size:.73rem;color:var(--acc);line-height:1.5}
.cliente-badge.show{display:block}
.cliente-badge strong{font-family:'Syne',sans-serif}
.email-detect-badge{display:none;margin-bottom:6px;padding:7px 11px;background:rgba(59,130,246,.1);border:1px solid rgba(59,130,246,.25);border-radius:8px;font-size:.72rem;color:#7eb8ff;line-height:1.5;animation:fadeIn .4s ease}
.email-detect-badge.show{display:flex;align-items:center;gap:7px}
.email-detect-badge svg{flex-shrink:0;opacity:.8}
@keyframes fadeIn{from{opacity:0;transform:translateY(-4px)}to{opacity:1;transform:translateY(0)}}
.slabel{font-family:'Syne',sans-serif;font-size:.62rem;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--mut);margin:22px 0 10px}
.slabel span{color:var(--red)}
.fcard{background:var(--card);border:1px solid var(--b1);border-radius:var(--r);padding:20px;margin-bottom:16px}
.field{margin-bottom:18px}.field:last-child{margin-bottom:0}
.field label{display:flex;align-items:center;gap:6px;font-size:.78rem;font-weight:500;color:var(--soft);margin-bottom:7px}
.field label .req{color:var(--red);font-size:.9em}
.field label .opt{font-size:.68rem;color:var(--mut);background:var(--b1);border-radius:4px;padding:1px 5px;font-style:italic}
.inp{width:100%;background:var(--surf);border:1.5px solid var(--b2);border-radius:var(--rs);color:var(--txt);font-family:'DM Sans',sans-serif;font-size:.92rem;padding:11px 14px;transition:border-color .15s,box-shadow .15s;outline:none;-webkit-appearance:none}
.inp::placeholder{color:var(--mut)}
.inp:focus{border-color:var(--acc);box-shadow:0 0 0 3px rgba(0,229,176,.1)}
.inp.error{border-color:var(--red);box-shadow:0 0 0 3px rgba(244,63,94,.1)}
.inp.ok{border-color:var(--acc2)}.inp.auto{border-color:rgba(59,130,246,.5);background:rgba(59,130,246,.05)}
.field-hint{font-size:.72rem;color:var(--mut);margin-top:5px;min-height:1em;transition:color .2s}
.field-hint.err{color:var(--red)}.field-hint.ok{color:var(--acc2)}.field-hint.info{color:#7eb8ff}
.tel-wrap{position:relative}
.tel-prefix{position:absolute;left:14px;top:50%;transform:translateY(-50%);font-size:.92rem;color:var(--soft);pointer-events:none;user-select:none}
.tel-wrap .inp{padding-left:32px}
.file-area{display:flex;flex-direction:column;align-items:center;gap:8px;padding:18px;background:var(--surf);border:1.5px dashed var(--b2);border-radius:var(--rs);cursor:pointer;transition:border-color .2s,background .2s;position:relative;overflow:hidden}
.file-area:hover{border-color:var(--acc);background:rgba(0,229,176,.04)}
.file-area.has-file{border-style:solid;border-color:var(--acc2);background:rgba(0,229,176,.06)}
.file-area.processing{border-color:var(--gold);background:rgba(245,158,11,.06)}
.file-area input[type="file"]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%}
.file-icon{font-size:1.6rem;line-height:1}
.file-lbl{font-size:.8rem;font-weight:500;color:var(--soft);text-align:center}
.file-area.has-file .file-lbl{color:var(--acc)}
.file-preview{display:none;margin-top:10px;border-radius:var(--rs);overflow:hidden;border:1px solid var(--b2)}
.file-preview.show{display:block}
.file-preview img{width:100%;max-height:160px;object-fit:cover;display:block}
.loc-btn{width:100%;display:flex;align-items:center;justify-content:center;gap:8px;padding:11px 14px;background:var(--surf);border:1.5px solid var(--b2);border-radius:var(--rs);color:var(--soft);font-family:'DM Sans',sans-serif;font-size:.88rem;font-weight:500;cursor:pointer;transition:border-color .2s,background .2s,color .2s}
.loc-btn:hover{border-color:var(--acc);color:var(--txt)}
.loc-btn.active{border-color:var(--acc2);background:rgba(0,229,176,.06);color:var(--acc)}
.loc-btn:disabled{opacity:.4;cursor:not-allowed}
.loc-info{display:none;margin-top:7px;font-size:.73rem;color:var(--soft);line-height:1.5}
.loc-info.show{display:block}
.divider{height:1px;background:var(--b1);margin:0 0 16px}
.progress-bar{height:3px;background:var(--b2);border-radius:99px;margin-bottom:20px;overflow:hidden;display:none}
.progress-bar.show{display:block}
.progress-fill{height:100%;border-radius:99px;background:linear-gradient(90deg,var(--acc),var(--blue));width:0%;transition:width .4s ease}
.fab-wrap{position:fixed;bottom:20px;left:0;right:0;max-width:430px;margin:0 auto;padding:0 16px;z-index:100}
.fab{width:100%;display:flex;align-items:center;justify-content:center;gap:10px;padding:16px 20px;background:#25D366;border:none;border-radius:99px;color:#fff;font-family:'Syne',sans-serif;font-size:1rem;font-weight:700;cursor:pointer;box-shadow:0 8px 32px rgba(37,211,102,.35),0 2px 8px rgba(0,0,0,.4);transition:transform .15s,box-shadow .15s,background .15s;position:relative;overflow:hidden}
.fab::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(255,255,255,.12) 0%,transparent 60%);border-radius:inherit}
.fab:hover:not(:disabled){background:#128C7E;transform:translateY(-2px);box-shadow:0 12px 40px rgba(37,211,102,.4),0 4px 12px rgba(0,0,0,.5)}
.fab:active{transform:scale(.97)}
.fab:disabled{background:var(--b2);box-shadow:none;cursor:not-allowed;color:var(--mut)}
.fab-loading{width:20px;height:20px;border:2px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin .8s linear infinite;display:none}
.fab.sending .fab-loading{display:block}.fab.sending .fab-icon{display:none}.fab.sending .fab-txt{opacity:.7}
@keyframes spin{to{transform:rotate(360deg)}}
#toast{position:fixed;bottom:86px;left:50%;transform:translateX(-50%) translateY(60px);background:var(--card2);border:1px solid var(--b2);padding:9px 18px;border-radius:99px;font-size:.8rem;color:var(--txt);box-shadow:0 8px 24px rgba(0,0,0,.5);transition:transform .3s cubic-bezier(.34,1.56,.64,1);white-space:nowrap;z-index:200;pointer-events:none;max-width:calc(100vw - 32px)}
#toast.show{transform:translateX(-50%) translateY(0)}
#toast.ok{border-color:rgba(0,229,176,.3);color:var(--acc)}
#toast.err{border-color:rgba(244,63,94,.3);color:#ff6b8a}
@media(max-width:360px){.res-grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<!-- TODO el HTML body original se mantiene intacto hasta el script -->

<script>
// ==============================================
// SOLO CAMBIOS MÍNIMOS AQUÍ - RESPETANDO TU CÓDIGO ORIGINAL
// ==============================================

// CAMBIA ESTA URL POR LA NUEVA QUE OBTUVISTE AL IMPLEMENTAR (la que ya es "Cualquier persona")
const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/https://script.google.com/macros/s/AKfycbyaeqN6Dq0JQh4eMtlQQwtnBEy5HdCrJ3HZd6_2RXjx9WPMafj57ajN5SVzBuxnn-OJqQ/exec/exec';  // ← ¡IMPORTANTE!

// Mantengo tus variables originales
let adminPhone = ADMIN_FALLBACK, adminEmail='', calcData=null, fotoINE=null, fotoCDom=null, ubicacion=null, enviando=false;

// ==============================================
// POST AJUSTADO - envía JSON y espera respuesta real
// ==============================================
async function postScript(payload){
  try{
    const resp = await fetch(APPS_SCRIPT_URL, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });

    if(!resp.ok){
      let err = await resp.text().catch(()=>'(sin detalles)');
      throw new Error(`HTTP ${resp.status} - ${err}`);
    }

    const json = await resp.json();
    console.log('Respuesta script:', json);
    return json;
  }catch(e){
    console.error('Error al llamar al script:', e);
    throw e;
  }
}

// ==============================================
// registrarEnScript - ajustado para tu script actual
// ==============================================
async function registrarEnScript(nombre,telefono){
  const correo = gi('correo').value.trim();
  const nota   = gi('nota').value.trim();
  if(correo) guardarCorreoLocal(correo);

  const payload = {
    nombre,
    telefono,
    correo,
    capital:   calcData?.capital ?? '',
    dias:      calcData?.dias ?? '',
    interesPct: calcData?.ip ?? '',
    interesM:  calcData?.it ?? '',
    total:     calcData?.tp ?? '',
    pagoDiario:calcData?.pd ?? '',
    latitud:   ubicacion?.lat ?? '',
    longitud:  ubicacion?.lng ?? '',
    direccion: ubicacion?.dir ?? '',
    fotoINE,
    fotoComprobante: fotoCDom ?? '',   // ← nombre que tu script espera
    notas:     nota,
    fecha:     new Date().toLocaleString('es-MX'),
    estado:    'Nuevo'
  };

  try{
    setProgress(40);
    toast('Guardando en base...', 'info');
    const res = await postScript(payload);

    if(res.success === true){
      toast('Guardado OK', 'ok');
      return true;
    }else{
      throw new Error(res.message || 'El script rechazó');
    }
  }catch(e){
    console.error('Fallo registro:', e);
    toast('No se guardó: ' + e.message, 'err');
    return false;
  }
}

// ==============================================
// enviar - ajustado para registrar ANTES de abrir WhatsApp
// ==============================================
async function enviar(){
  if(enviando) return;

  const nombre   = gi('nombre').value.trim();
  const telefono = gi('telefono').value.trim();
  const correo   = gi('correo').value.trim();

  // Tus validaciones originales
  const errNombre = validarNombre(nombre);
  const errTel    = validarTelefono(telefono);
  const errCorreo = validarCorreo(correo);

  if(errNombre){ /* tu código de error */ return; }
  if(errTel){    /* tu código de error */ return; }
  if(errCorreo){ /* tu código de error */ return; }

  enviando = true;
  const fab = gi('fab');
  fab.classList.add('sending');
  fab.disabled = true;

  try{
    setProgress(30);
    const registrado = await registrarEnScript(nombre, telefono);

    if(!registrado){
      throw new Error('No se pudo guardar la solicitud');
    }

    setProgress(70);
    const msg = construirMensaje();  // tu función original
    const waUrl = `https://wa.me/${adminPhone}?text=${encodeURIComponent(msg)}`;

    toast('Abriendo WhatsApp...', 'ok');
    await new Promise(r => setTimeout(r, 600));
    window.open(waUrl, '_blank');

    setProgress(100);
    toast('¡Listo! Solicitud guardada y enviada', 'ok');

    setTimeout(()=>{ setProgress(0); window.location.href='index.html'; }, 3000);

  }catch(e){
    toast('Error: ' + e.message, 'err');
  }finally{
    enviando = false;
    fab.classList.remove('sending');
    fab.disabled = false;
  }
}

// En init() o donde tengas el onclick del botón, asegúrate de usar:
gi('fab').onclick = enviar;   // o addEventListener('click', enviar);

// El resto de tu script original (cargarSimulacion, renderResumen, setupFile, etc.) se mantiene igual
</script>
</body>
</html>
